name: ðŸ”’ Pre-commit Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  pre-commit-security:
    name: Pre-commit Security Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # æ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒã‚§ãƒƒã‚¯
    - name: ðŸ” Secret Detection
      run: |
        echo "ðŸ” Checking for secrets in code..."
        
        # APIã‚­ãƒ¼ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
        if grep -r -E "(api_key|password|secret|token|private_key)" --include="*.js" --include="*.ts" --include="*.json" .; then
          echo "âŒ æ½œåœ¨çš„ãªæ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          exit 1
        fi
        
        # .env ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¤ã‚³ãƒŸãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        if find . -name "*.env*" -not -path "./node_modules/*" | grep -v ".gitignore"; then
          echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™"
          exit 1
        fi
        
        echo "âœ… æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯å®Œäº†"

    # å€‹äººæƒ…å ±æ¤œå‡ºãƒã‚§ãƒƒã‚¯
    - name: ðŸ¥ Medical Privacy Check
      run: |
        echo "ðŸ¥ åŒ»ç™‚é–¢é€£å€‹äººæƒ…å ±ãƒã‚§ãƒƒã‚¯..."
        
        # æ—¥æœ¬ã®å€‹äººæƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢
        if grep -r -E "(æ‚£è€…|æ°å|ç”Ÿå¹´æœˆæ—¥|ä½æ‰€|é›»è©±ç•ªå·|è¨ºæ–­)" --include="*.js" --include="*.ts" --include="*.md" . || true; then
          echo "âš ï¸ åŒ»ç™‚é–¢é€£ç”¨èªžãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        echo "âœ… åŒ»ç™‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†"

    # è„†å¼±ãªã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯  
    - name: ðŸš¨ Vulnerable Code Pattern Check
      run: |
        echo "ðŸš¨ è„†å¼±ãªã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯..."
        
        # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§
        if grep -r "query.*\+.*req\." --include="*.js" --include="*.ts" .; then
          echo "âŒ SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ã®å¯èƒ½æ€§"
          exit 1
        fi
        
        # XSSè„†å¼±æ€§
        if grep -r "innerHTML.*req\." --include="*.js" --include="*.ts" .; then
          echo "âŒ XSSè„†å¼±æ€§ã®å¯èƒ½æ€§"
          exit 1
        fi
        
        # evalä½¿ç”¨ãƒã‚§ãƒƒã‚¯
        if grep -r "eval(" --include="*.js" --include="*.ts" .; then
          echo "âŒ eval()ã®ä½¿ç”¨ã¯å±é™ºã§ã™"
          exit 1
        fi
        
        echo "âœ… è„†å¼±ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯å®Œäº†"

    # ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    - name: ðŸ“¦ Dependency Security Audit
      run: |
        echo "ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»..."
        npm audit --audit-level moderate
        echo "âœ… ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å®Œäº†"

    # Linting & Formatting
    - name: ðŸŽ¨ Code Quality Check
      run: |
        echo "ðŸŽ¨ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯..."
        
        # ESLintã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
          npm run lint || echo "âš ï¸ Lintãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        
        echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šç¢ºèª
    - name: âš™ï¸ Security Configuration Check
      run: |
        echo "âš™ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šç¢ºèª..."
        
        # .gitignoreã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£é™¤å¤–é …ç›®ãŒã‚ã‚‹ã‹ç¢ºèª
        if ! grep -q "*.env" .gitignore; then
          echo "âŒ .gitignoreã«*.envãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        # SECURITY.mdã®å­˜åœ¨ç¢ºèª
        if [ ! -f "SECURITY.md" ]; then
          echo "âŒ SECURITY.mdãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šç¢ºèªå®Œäº†"

    - name: ðŸ“Š Security Check Summary
      if: always()
      run: |
        echo "## ðŸ›¡ï¸ Pre-commit Security Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **æ©Ÿå¯†æƒ…å ±æ¤œå‡º**: å®Œäº†" >> $GITHUB_STEP_SUMMARY  
        echo "âœ… **åŒ»ç™‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: ç¢ºèªæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **è„†å¼±ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³**: æ¤œæŸ»å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **ä¾å­˜é–¢ä¿‚ç›£æŸ»**: å®Ÿè¡Œæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š**: ç¢ºèªæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY